<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Klaviyo OpenAI Prediction App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">Klaviyo OpenAI Prediction App</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="setup.html">Setup</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="page-header">
            <h1>API Setup</h1>
            <p class="lead">Connect your Klaviyo and OpenAI accounts to get started</p>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="api-key-form">
                    <h3><i class="bi bi-key me-2"></i>Klaviyo API</h3>
                    <p>Enter your Klaviyo Private API Key to connect to your account.</p>
                    <div class="mb-3">
                        <label for="klaviyoApiKey" class="form-label">Klaviyo Private API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="klaviyoApiKey" placeholder="pk_XXXXXXXXXXXXXXXXXXXXXXXX">
                            <button class="btn btn-outline-secondary" type="button" id="toggleKlaviyoKey">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Your API key is stored locally in your browser and never sent to our servers.</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useSampleKlaviyoData">
                            <label class="form-check-label" for="useSampleKlaviyoData">
                                Use sample data (no API key required)
                            </label>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="https://www.klaviyo.com/account#api-keys-tab" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right me-2"></i>Get Klaviyo API Key
                        </a>
                        <button class="btn btn-primary" id="testKlaviyoConnection">Test Connection</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="api-key-form">
                    <h3><i class="bi bi-robot me-2"></i>OpenAI API</h3>
                    <p>Enter your OpenAI API Key to enable AI-powered predictions.</p>
                    <div class="mb-3">
                        <label for="openaiApiKey" class="form-label">OpenAI API Key</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="openaiApiKey" placeholder="sk-XXXXXXXXXXXXXXXXXXXXXXXX">
                            <button class="btn btn-outline-secondary" type="button" id="toggleOpenAIKey">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Your API key is stored locally in your browser and never sent to our servers.</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useSampleOpenAIData">
                            <label class="form-check-label" for="useSampleOpenAIData">
                                Use sample data (no API key required)
                            </label>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="https://platform.openai.com/api-keys" target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right me-2"></i>Get OpenAI API Key
                        </a>
                        <button class="btn btn-primary" id="testOpenAIConnection">Test Connection</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-card mt-4">
            <h3>Data Privacy & Security</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="bi bi-shield-lock me-2"></i>Client-Side Processing</h5>
                    <p>All API requests are made directly from your browser to Klaviyo and OpenAI. Your API keys and data never pass through our servers.</p>
                </div>
                <div class="col-md-6">
                    <h5><i class="bi bi-browser-chrome me-2"></i>Local Storage</h5>
                    <p>Your API keys are stored securely in your browser's local storage and are only accessible on your device.</p>
                </div>
                <div class="col-md-6">
                    <h5><i class="bi bi-eye-slash me-2"></i>No Data Collection</h5>
                    <p>We don't collect, store, or have access to any of your Klaviyo data or OpenAI usage.</p>
                </div>
                <div class="col-md-6">
                    <h5><i class="bi bi-key me-2"></i>API Key Security</h5>
                    <p>For maximum security, consider creating restricted API keys with only the necessary permissions.</p>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a href="index.html" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>Back to Home
            </a>
            <button class="btn btn-primary btn-lg" id="saveAndContinue">
                Save and Continue<i class="bi bi-arrow-right ms-2"></i>
            </button>
        </div>
    </div>

    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>Klaviyo OpenAI Prediction App</h5>
                    <p>Identify which subscribers are most likely to purchase based on their behavior patterns.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>Created with ❤️ for Klaviyo users</p>
                    <p>© 2025 Klaviyo OpenAI Prediction App</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle password visibility
            document.getElementById('toggleKlaviyoKey').addEventListener('click', function() {
                const input = document.getElementById('klaviyoApiKey');
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });

            document.getElementById('toggleOpenAIKey').addEventListener('click', function() {
                const input = document.getElementById('openaiApiKey');
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('bi-eye');
                    icon.classList.add('bi-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('bi-eye-slash');
                    icon.classList.add('bi-eye');
                }
            });

            // Load saved API keys if they exist
            const klaviyoApiKey = localStorage.getItem('klaviyoApiKey');
            const openaiApiKey = localStorage.getItem('openaiApiKey');
            const useSampleKlaviyoData = localStorage.getItem('useSampleKlaviyoData') === 'true';
            const useSampleOpenAIData = localStorage.getItem('useSampleOpenAIData') === 'true';

            if (klaviyoApiKey) {
                document.getElementById('klaviyoApiKey').value = klaviyoApiKey;
            }
            if (openaiApiKey) {
                document.getElementById('openaiApiKey').value = openaiApiKey;
            }
            document.getElementById('useSampleKlaviyoData').checked = useSampleKlaviyoData;
            document.getElementById('useSampleOpenAIData').checked = useSampleOpenAIData;

            // Test Klaviyo connection
            document.getElementById('testKlaviyoConnection').addEventListener('click', function() {
                const apiKey = document.getElementById('klaviyoApiKey').value;
                const useSampleData = document.getElementById('useSampleKlaviyoData').checked;
                
                if (useSampleData) {
                    showAlert('success', 'Sample data mode is enabled. No API connection needed.');
                    return;
                }
                
                if (!apiKey) {
                    showAlert('danger', 'Please enter a Klaviyo API key or enable sample data mode.');
                    return;
                }
                
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
                this.disabled = true;
                
                testKlaviyoConnection(apiKey)
                    .then(result => {
                        if (result.success) {
                            showAlert('success', 'Klaviyo connection successful!');
                        } else {
                            showAlert('danger', 'Klaviyo connection failed: ' + result.message);
                        }
                    })
                    .catch(error => {
                        showAlert('danger', 'Klaviyo connection failed: ' + error.message);
                    })
                    .finally(() => {
                        this.innerHTML = 'Test Connection';
                        this.disabled = false;
                    });
            });

            // Test OpenAI connection
            document.getElementById('testOpenAIConnection').addEventListener('click', function() {
                const apiKey = document.getElementById('openaiApiKey').value;
                const useSampleData = document.getElementById('useSampleOpenAIData').checked;
                
                if (useSampleData) {
                    showAlert('success', 'Sample data mode is enabled. No API connection needed.');
                    return;
                }
                
                if (!apiKey) {
                    showAlert('danger', 'Please enter an OpenAI API key or enable sample data mode.');
                    return;
                }
                
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
                this.disabled = true;
                
                testOpenAIConnection(apiKey)
                    .then(result => {
                        if (result.success) {
                            showAlert('success', 'OpenAI connection successful!');
                        } else {
                            showAlert('danger', 'OpenAI connection failed: ' + result.message);
                        }
                    })
                    .catch(error => {
                        showAlert('danger', 'OpenAI connection failed: ' + error.message);
                    })
                    .finally(() => {
                        this.innerHTML = 'Test Connection';
                        this.disabled = false;
                    });
            });

            // Save and continue
            document.getElementById('saveAndContinue').addEventListener('click', function() {
                const klaviyoApiKey = document.getElementById('klaviyoApiKey').value;
                const openaiApiKey = document.getElementById('openaiApiKey').value;
                const useSampleKlaviyoData = document.getElementById('useSampleKlaviyoData').checked;
                const useSampleOpenAIData = document.getElementById('useSampleOpenAIData').checked;
                
                if (!klaviyoApiKey && !useSampleKlaviyoData) {
                    showAlert('danger', 'Please enter a Klaviyo API key or enable sample data mode.');
                    return;
                }
                
                if (!openaiApiKey && !useSampleOpenAIData) {
                    showAlert('danger', 'Please enter an OpenAI API key or enable sample data mode.');
                    return;
                }
                
                // Save to local storage
                localStorage.setItem('klaviyoApiKey', klaviyoApiKey);
                localStorage.setItem('openaiApiKey', openaiApiKey);
                localStorage.setItem('useSampleKlaviyoData', useSampleKlaviyoData);
                localStorage.setItem('useSampleOpenAIData', useSampleOpenAIData);
                
                // Redirect to dashboard
                window.location.href = 'dashboard.html';
            });

            // Helper function to show alerts
            function showAlert(type, message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insert after the page header
                const pageHeader = document.querySelector('.page-header');
                pageHeader.parentNode.insertBefore(alertDiv, pageHeader.nextSibling);
                
                // Auto dismiss after 5 seconds
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }, 5000);
            }
        });
    </script>
</body>
</html>
